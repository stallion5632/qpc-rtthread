# 实现原理

## qf_opt_layer

`qf_opt_layer.c` 实现了RT-Thread下QP/C的事件分级调度与优化层，核心原理如下：

### 1. 分级事件暂存缓冲（Staging Buffers）
- 事件根据优先级（高/普通/低）进入不同的环形暂存缓冲区（l_stagingBuffers）。
- 每个缓冲区为定长队列，溢出时有独立统计。

### 2. 调度线程与信号量
- 独立调度线程 dispatcherThread，优先级可配置。
- 线程通过信号量唤醒，批量处理各优先级缓冲区的事件。
- 空闲钩子（idle hook）自动检测缓冲区有事件时唤醒调度线程。

### 3. 策略接口（Strategy Pattern）
- 通过 QF_DispatcherStrategy 结构体，支持自定义事件合并、优先级比较、丢弃、分级等策略。
- 可动态切换策略（如默认策略、高性能策略）。

### 4. 批量处理与合并/丢弃/重试
- 调度线程每次批量取出同优先级事件，遍历处理：
  - 支持事件合并（如信号相同可合并，减少冗余）。
  - 支持事件丢弃（如队列过满、非关键事件可丢弃）。
  - 支持事件重试（如关键事件投递失败可降级重试）。
- 事件最终通过RT-Thread邮箱投递到目标AO。

### 5. 运行时统计与调优
- 实时统计调度周期、处理事件数、合并/丢弃/重试数、最大/平均批量、队列溢出等。
- 支持接口获取和重置统计数据，便于性能分析和调优。

### 6. 典型流程
1. AO或ISR通过QF_postFromISR等接口投递事件，事件进入分级缓冲。
2. 调度线程被唤醒，批量处理各级缓冲区事件。
3. 按策略合并/丢弃/重试，最终投递到目标AO邮箱。
4. 应用可通过接口/命令获取运行时统计，辅助调优。
